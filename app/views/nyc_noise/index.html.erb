<div class="container">
  <label for="hour" style="font-size:16pt;">Time of day (in hourly increments):</label>
  <input type="text" id="hour" readonly style="border:0; color:#f6931f; font-size:18pt; font-weight:bold;">
</div>

<div id="slider"></div>

<div id="map-canvas"></div>

<div id="panel">
  <div class="dropup">
    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Noise Complaint Type
    <span class="caret"></span></button>
    <ul class="dropdown-menu">
    </ul>
  </div>
  <div id = "desc">"foo"</div>
</div>

<script>

  // var map, heatmap;
  // var type_layers = {};
  //var current_type = 'All Data';


  // function createTypeLayers() {
  //   var hour, data, pointArray;

  //   <% @twenty_four_types.each do |type, hours| %>
  //     var noise_per_hour = {};

  //     <% hours.each.with_index do |h, index| %>
  //       hour = <%= index %>;
  //       data = [];

  //       <% h.each do |noise| %>
  //         data.push(new google.maps.LatLng(<%= noise.latitude.to_f %>, <%= noise.longitude.to_f %>));
  //       <% end %>

  //       pointArray = new google.maps.MVCArray(data);
  //       noise_per_hour[hour] = new google.maps.visualization.HeatmapLayer({
  //         data: pointArray,
  //         opacity: .9,
  //         radius: 25
  //       });
  //     <% end %>

  //     type_layers['<%= type %>'] = noise_per_hour
  //   <% end %>
  // }

  function initData() {
    var hour, data, pointArray;
    var noise_per_hour = {};

    <% @all_twenty_four.each.with_index do |h, index| %>
      hour = <%= index %>;
      data = [];

      <% h.each do |noise| %>
        data.push(new google.maps.LatLng(<%= noise.latitude.to_f %>, <%= noise.longitude.to_f %>));
      <% end %>

      pointArray = new google.maps.MVCArray(data);
      noise_per_hour[hour] = new google.maps.visualization.HeatmapLayer({
        data: pointArray,
        opacity: .9,
        radius: 25
      });
    <% end %>

    type_layers['All Data'] = noise_per_hour;
  }

  function dropdownLabels() {
    <% @complaint_types.each do |type| %>
      $('#panel > .dropup > ul').append('<li>' + '<%= type %>' + '</li>');
    <% end %>
  }

  function initialize() {

    var styling = [{"featureType":"water","elementType":"geometry","stylers":[{"color":"#e9e9e9"},{"lightness":17}]},{"featureType":"landscape","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":20}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"color":"#ffffff"},{"lightness":17}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#ffffff"},{"lightness":29},{"weight":0.2}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":18}]},{"featureType":"road.local","elementType":"geometry","stylers":[{"color":"#ffffff"},{"lightness":16}]},{"featureType":"poi","elementType":"geometry","stylers":[{"color":"#f5f5f5"},{"lightness":21}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#dedede"},{"lightness":21}]},{"elementType":"labels.text.stroke","stylers":[{"visibility":"on"},{"color":"#ffffff"},{"lightness":16}]},{"elementType":"labels.text.fill","stylers":[{"saturation":36},{"color":"#333333"},{"lightness":40}]},{"elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"geometry","stylers":[{"color":"#f2f2f2"},{"lightness":19}]},{"featureType":"administrative","elementType":"geometry.fill","stylers":[{"color":"#fefefe"},{"lightness":20}]},{"featureType":"administrative","elementType":"geometry.stroke","stylers":[{"color":"#fefefe"},{"lightness":17},{"weight":1.2}]}]

    var mapOptions = {
      zoom: 11,
      streetViewControl: false, 
      panControl: true, 
      styles: styling,
      mapTypeControl: false, 
      center: new google.maps.LatLng(40.7731295,-73.957734),
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    map = new google.maps.Map(document.getElementById('map-canvas'),
    mapOptions);

    dropdownLabels();
    initData();

    heatmap = type_layers[current_type][12];

    heatmap.setMap(map);
  }

  function toggleHeatmap() {
    heatmap.setMap(heatmap.getMap() ? null : map);
  }

  $( "#slider" ).on( "slide", function( event, ui ) {
    heatmap.setMap(null);
    if (!!type_layers[current_type][ui.value]) {
      heatmap = type_layers[current_type][ui.value];
      heatmap.setMap(map);
    }
  });

  $(".dropdown-menu").on("click", "li", function(e) {
    $.ajax({
      url: '/descriptor',
      method: 'GET',
      data: {descriptor: $(e.target).text()},
      dataType: 'script'
    });
  });

  google.maps.event.addDomListener(window, 'load', initialize);
</script>
